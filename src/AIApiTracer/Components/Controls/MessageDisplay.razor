@using AIApiTracer.Services.MessageParsing
@using System.Text.Json

<div class="message-display">
    @if (ParsedData != null && ParsedData.Messages.Any())
    {
        <div class="space-y-2">
            @foreach (var message in ParsedData.Messages)
            {
                <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-medium px-2 py-1 rounded @GetRoleClass(message.Role)">
                            @message.Role
                        </span>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(message.Content))
                    {
                        <div class="text-sm text-gray-800 whitespace-pre-wrap">@message.Content</div>
                    }
                    else if (message.ContentParts != null)
                    {
                        <div class="space-y-2">
                            @foreach (var part in message.ContentParts)
                            {
                                @if (part.Type == "text" && !string.IsNullOrEmpty(part.Text))
                                {
                                    <div class="text-sm text-gray-800 whitespace-pre-wrap">@part.Text</div>
                                }
                                else if (part.Type == "image" && !string.IsNullOrEmpty(part.ImageUrl))
                                {
                                    <div class="flex items-center gap-2 text-sm text-gray-600">
                                        <i class="icon-ic_fluent_image_20_regular"></i>
                                        <span>Image content</span>
                                    </div>
                                }
                                else if (part.Type == "tool_use")
                                {
                                    <div class="flex items-center gap-2 text-sm text-gray-600">
                                        <i class="icon-ic_fluent_wrench_20_regular"></i>
                                        <span>Tool use: @(part.OtherData?.TryGetValue("name", out var nameEl) == true ? nameEl.GetString() : "unknown")</span>
                                    </div>
                                }
                                else if (part.Type == "tool_result")
                                {
                                    <div class="flex items-center gap-2 text-sm text-gray-600">
                                        <i class="icon-ic_fluent_checkmark_circle_20_regular"></i>
                                        <span>Tool result</span>
                                        @if (!string.IsNullOrEmpty(part.Text))
                                        {
                                            <span class="text-gray-800">: @part.Text</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="text-sm text-gray-600">[@part.Type content]</div>
                                }
                            }
                        </div>
                    }
                    
                    @* Display tool calls associated with this message *@
                    @if (message.ToolCalls != null && message.ToolCalls.Any())
                    {
                        <div class="mt-3 space-y-2">
                            @foreach (var toolCall in message.ToolCalls)
                            {
                                <div class="border border-blue-200 rounded-lg p-3 bg-blue-50">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="icon-ic_fluent_wrench_20_regular text-blue-600"></i>
                                        <span class="text-sm font-medium text-blue-900">@toolCall.Name</span>
                                        <span class="text-xs text-blue-600">(@toolCall.Id)</span>
                                    </div>
                                    
                                    @if (toolCall.Arguments != null)
                                    {
                                        <div class="mt-2">
                                            <div class="text-xs font-medium text-gray-600 mb-1">Arguments:</div>
                                            <pre class="text-xs bg-white p-2 rounded border border-gray-200 overflow-x-auto">@FormatJson(toolCall.Arguments.Value)</pre>
                                        </div>
                                    }
                                    
                                    @if (!string.IsNullOrEmpty(toolCall.Result))
                                    {
                                        <div class="mt-2">
                                            <div class="text-xs font-medium text-gray-600 mb-1">Result:</div>
                                            <div class="text-sm text-gray-800 whitespace-pre-wrap">@toolCall.Result</div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
        
        @* Display any tool calls not associated with a message (for backward compatibility) *@
        @if (ParsedData.ToolCalls.Any(tc => !ParsedData.Messages.Any(m => m.ToolCalls?.Contains(tc) == true)))
        {
            <div class="mt-3 space-y-2">
                @foreach (var toolCall in ParsedData.ToolCalls.Where(tc => !ParsedData.Messages.Any(m => m.ToolCalls?.Contains(tc) == true)))
                {
                    <div class="border border-blue-200 rounded-lg p-3 bg-blue-50">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="icon-ic_fluent_wrench_20_regular text-blue-600"></i>
                            <span class="text-sm font-medium text-blue-900">@toolCall.Name</span>
                            <span class="text-xs text-blue-600">(@toolCall.Id)</span>
                        </div>
                        
                        @if (toolCall.Arguments != null)
                        {
                            <div class="mt-2">
                                <div class="text-xs font-medium text-gray-600 mb-1">Arguments:</div>
                                <pre class="text-xs bg-white p-2 rounded border border-gray-200 overflow-x-auto">@FormatJson(toolCall.Arguments.Value)</pre>
                            </div>
                        }
                        
                        @if (!string.IsNullOrEmpty(toolCall.Result))
                        {
                            <div class="mt-2">
                                <div class="text-xs font-medium text-gray-600 mb-1">Result:</div>
                                <div class="text-sm text-gray-800 whitespace-pre-wrap">@toolCall.Result</div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    }
    else
    {
        <div class="text-sm text-gray-500">No messages found</div>
    }
</div>

@code {
    [Parameter] public ParsedMessageData? ParsedData { get; set; }
    
    private string GetRoleClass(string role)
    {
        return role.ToLower() switch
        {
            "system" => "bg-purple-100 text-purple-800",
            "user" => "bg-blue-100 text-blue-800",
            "assistant" => "bg-green-100 text-green-800",
            "tool" => "bg-orange-100 text-orange-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }
    
    private string FormatJson(JsonElement element)
    {
        try
        {
            return JsonSerializer.Serialize(element, new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return element.ToString();
        }
    }
}